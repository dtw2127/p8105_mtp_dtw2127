---
title: "p8105_mtp_dtw2127"
author: "Dee Wang"
date: "27/10/2021"
output: github_document
---

```{r setup, include = FALSE}
library(tidyverse)
library(readxl)
library(ggplot2)
library(patchwork)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

## Introduction 

## Problem 1 
First we will import and clean the data. We will fill in missing values for eop_size_mm with 0s, and convert categorical variables into character and ordered factors. 

```{r}
nature_data = read_excel("./data/p8105_mtp_data.xlsx", sheet = "this one", skip = 8) %>%
  janitor::clean_names() %>% 
  mutate(sex = as.factor(sex),
         age_group = as.factor(age_group),
         eop_size = as.factor(eop_size), 
         eop_shape = as.factor(eop_shape),
         fhp_category = as.factor(fhp_category))

nature_data[["eop_size_mm"]][is.na(nature_data[["eop_size_mm"]])] <- 0 

nature_data %>% 
  mutate(age_group = recode(age_group,
                            `1` = "<18 yrs",
                            `2` = "18-30 yrs", 
                            `3` = "31-40 yrs",
                            `4` = "41-50 yrs",
                            `5` = "51-60 yrs",
                            `6` = "61-70 yrs",
                            `7` = "71-80 yrs",
                            `8` = "81-90 yrs")) %>%
  mutate(sex = recode(sex, 
                      `0` = "female",
                      `1` = "male")) %>% 
  group_by(age_group, sex) %>%
  summarize(n_obs = n()) %>%
pivot_wider(
  names_from = age_group,
  values_from = n_obs
) 

#check the recoding
```

Key variables in the dataset include sex and age, EOP size, EOP visibility classification, EOP shape and FHP size. There are `r nrow(nature_data)`participants included in the dataset. The largest age group is 18-30 years old, and the smallest age groups are < 18 years and 81-90 years. There are roughly equal number of males and females in each age group, and the number of individuals in each group is similar for the age groups between 31-80 years of age.  

Let's check to see that the categorical variables were correctly assigned. 

```{r}

nature_data_check = nature_data %>% 
  mutate(correct_age_category = 
           case_when(age < 18 ~ 1,
                     age >= 18 & age <= 30 ~ 2, 
                     age >= 31 & age <= 40 ~ 3, 
                     age >= 41 & age <= 50 ~ 4, 
                     age >= 51 & age <= 60 ~ 5, 
                     age >= 61 & age <= 70 ~ 6, 
                     age >= 71 & age <= 80 ~ 7, 
                     age >= 81 & age <= 90 ~ 8), 
         age_check = ifelse(correct_age_category == age_group, "correct", "incorrect"), 
         correct_size_category = 
           case_when(eop_size_mm < 5 ~ 0, 
                     eop_size_mm >= 5 & eop_size_mm < 10 ~ 1, 
                     eop_size_mm >= 10 & eop_size_mm < 15 ~ 2, 
                     eop_size_mm >= 15 & eop_size_mm < 20 ~ 3,
                     eop_size_mm >= 20 & eop_size_mm <= 25 ~ 4,
                     eop_size_mm >= 25 ~ 5)
  ) 

#note to self, check age categories were made correctly 

nature_data_check %>% 
  filter(age_check == "incorrect") %>% 
  knitr::kable()

```
## Problem 2 

For Figure 3, a boxplot might be more appropriate. We will re-categorize age groups 7 and 8 as 6, since we will be grouping observations from these three age groups. 

```{r}

nature_data_age = nature_data %>% 
  filter(as.numeric(age_group) > 1) %>% 
  mutate(age_group = recode(age_group, 
                            `2` = "18-30 years", 
                            `3` = "31-40 years",
                            `4` = "41-50 years", 
                            `5` = "51-60 years",
                            `6` = "60+ years",
                            `7` = "60+ years", 
                            `8` = "60+ years")
         ) 

figure_3 = ggplot(nature_data_age, aes(x = age_group, y = fhp_size_mm, fill = sex)) + geom_boxplot()

```

For Figure 4, we'd like to look at rates of enlarged EOP, instead of numbers with enlarged EOP. 

```{r}
#figure out how many individuals are in each age + sex group 

nature_data_age_n = nature_data_age %>% 
  group_by(age_group, sex) %>% 
  summarize(n_obs = n())

nature_data_eop_n = nature_data_age %>% 
  filter(as.numeric(eop_size) >= 3) %>%
  group_by(age_group, sex) %>% 
  summarize(n_obs = n())

nature_data_combined = cbind(nature_data_age_n, nature_data_eop_n) %>%
  mutate(rate = n_obs...6 * 100 / n_obs...3)

figure_4 = 
  nature_data_combined %>% 
  ggplot(aes(x = age_group...4, y = rate)) + 
  geom_line(aes(group = sex...2)) + 
  geom_point() + 
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "age group", y = "rate (# of eeops/# of individuals)")

(figure_3 + figure_4)

```

